<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/scale-down-animation.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="play-list.html">
<dom-module id="detail-player">
	<style type="text/css">
		:host
		{
			position: absolute;
			/*display: none;*/
			bottom: 0px;
			right: 0px;
		}
		#detailPlayer
		{
			width: 400px;
			
			background-color: #FAFAFA;
			display: block;
			border-radius: 2px;
			position:relative;
		}
		.playerContentContainer
		{
			width: 400px;
			height: 400px;
		}
		.playerContentContainer .playingAlbumCover
		{
			background-color: var(--paper-grey-500);
			width:100%;
			height:100%;
		}
		.playerTrackContainer
		{
			display: block;
			text-align: center;
			margin-top: 8px;
			margin-bottom: 8px;
			height: 70px;
			position:relative;
			width:100%;
		}

		.playerControlContainer paper-slider
		{
			width: 400px;
		}
		.playerControl
		{
			width: 400px;
			display: flex;
			display: -webkit-flex;
			justify-content:center;
			align-items:center;
			-webkit-justify-content:center;
			-webkit-align-items:center;
			padding-bottom: 8px;
		}
		.playerControlContainer
		{
			width: 100%;
		}
		paper-toolbar.playerHeader
		{
			z-index:10;
			--paper-toolbar:
			{
				background: none;
				color:black;
			};
		}
		paper-icon-button.larger::shadow #icon
		{
			width: 48px;
			height: 48px;
		}
	</style>
	<template>
		<paper-material elevation="4" id="detailPlayer">
			
			<paper-toolbar class="playerHeader">
				<paper-icon-button style="width:27px" icon="list" on-click="showPlayList"></paper-icon-button>
				<div class="title">Playing</div>
				<paper-icon-button style="width:27px" icon="close"></paper-icon-button>
			</paper-toolbar>
						
			<div class="playerContentContainer">
				<div class="playingAlbumCover">
					
				</div>
				
				<play-list id="playListContainer" play-list="{{tracks}}"></play-list>
				
			</div>
			
			<div class="playerTrackContainer">
				<h2>{{tracks.0.name}}</h2>
				<p>{{tracks.0.artist}}</p>
				<p>{{tracks.0.album}}</p>
			</div>
			<div class="playerControlContainer">
				
				<paper-slider id="playerProgress" value="0" max="300" secondary-progress="100" on-change="sliderSeek">
				</paper-slider>
				
				<div class="playerControl">
					<paper-icon-button icon="av:repeat" disabled></paper-icon-button>
					<paper-icon-button class="larger" icon="av:skip-previous"></paper-icon-button>
					<paper-icon-button class="larger" icon="av:play-arrow" on-click="playClicked" id="playButton"></paper-icon-button>
					<paper-icon-button class="larger" icon="av:skip-next"></paper-icon-button>
					<paper-icon-button icon="av:shuffle" disabled></paper-icon-button>
				</div>
			</div>
		</paper-material>

		<audio id="audioElement">
			<source id="sourceElement" src="" type="audio/mpeg" codecs="mp3"/>
		</audio>
	</template>
	<script type="text/javascript">
		var audioElement;
		var playBackProgress = 0;
		var playButton;
		var playing = false;

		Polymer({
			is:"detail-player",
			behaviors: [
		      Polymer.NeonAnimationRunnerBehavior
		    ],
			properties:
			{
				tracks:
				{
					type:Array,
					notify:true,
					observer:"_trackObjectChanged"
				},
				animationConfig: {
			        type: Object,
			        value: function() {
			          	return {
				            'entry': [{
					            name: 'scale-up-animation',
					            node: this,
					            transformOrigin: '90% 110%'
				            }],
				            'exit': [{
					            name: 'scale-down-animation',
					            node: this,
					            transformOrigin: '90% 110%'
				            }]
			          	}
			        }
			    },
			   _showing: {
			        type: Boolean,
			        value: false
		      	}
			},
			listeners: 
			{
				'neon-animation-finish': '_onAnimationFinish',
				'audioElement.ontimeupdate':'timeUpdated'
		   },
		   _onAnimationFinish: function() {
		      if (this._showing) {
		      } else {
		        this.style.display = '';
		      }
		   },
			ready:function()
			{
				audioElement = this.$$('#audioElement');
				progressElement = this.$$('#playerProgress');
				playButton = this.$$("#playButton");

				audioElement.ontimeupdate = function ()
				{
					if(Math.round(300 * audioElement.currentTime/audioElement.duration) > playBackProgress)
					{
						playBackProgress = 300 * audioElement.currentTime/audioElement.duration;
						progressElement.value = playBackProgress;
					}
				}

				audioElement.onpause = function ()
				{

					if(audioElement.currentTime == audioElement.duration)
			   		{
			   			progressElement.value = 0;
			   		}

			   		playButton.icon = "av:play-arrow";
			   		playing = false;
				}

				this.tracks = [
					{
						"name":"Nothing to see here",
						"artist":"foo",
						"album":"bar"
					}
				];
				
			},
			_trackObjectChanged: function(newValue, oldValue)
			{
				if(newValue[0].file != null)
				{
					playBackProgress = 0;
					progressElement.value = playerProgress;
					var url = "/api/stream/" + newValue[0].file;
					this.$$("#sourceElement").src = url;
					audioElement.load();
					audioElement.play();
					playing = true;
					this.$$("#playButton").icon = "av:pause";
				}
			},
			show: function() 
			{
		      this.style.display = 'block';
		      this._showing = true;
		      this.playAnimation('entry');
		   	},
		   	hide: function() 
		   	{
		      this._showing = false;
		      this.playAnimation('exit');
		   	},
		   	playClicked:function()
		   	{
		   		if(!playing)
		   		{
		   			this.$$("#playButton").icon = "av:pause";
		   			playing = true;
		   			audioElement.play();
		   		}
		   		else
		   		{
		   			this.$$("#playButton").icon = "av:play-arrow";
		   			playing = false;
		   			audioElement.pause();
		   		}
		   	},
		   	sliderSeek:function(e)
		   	{
		   		audioElement.currentTime = progressElement.value / 300*audioElement.duration;
		   	},
		   	showPlayList:function()
		   	{
		   		this.$$("#playListContainer").changeVisible();
		   	}
		});
	</script>
</dom-module>